<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- ... (остальные meta-теги и стили остаются без изменений) ... -->
</head>
<body>
    <div class="container">
        <h1>Добро пожаловать!</h1>
        <div id="auth-button">
            <button onclick="loginWithTelegram()">Войти через Telegram</button>
        </div>
        <div id="user-info" class="user-info" style="display: none;">
            <p>Привет, <span id="username"></span>!</p>
        </div>
    </div>

    <script>
  // 1. Проверяем авторизацию при загрузке
  document.addEventListener('DOMContentLoaded', () => {
    checkAuth();
  });

  // 2. Основная функция проверки авторизации
  function checkAuth() {
    // Вариант 1: Уже авторизован в WebApp
    if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
      const tgUser = Telegram.WebApp.initDataUnsafe.user;
      handleSuccessAuth(tgUser);
      return;
    }

    // Вариант 2: Есть сохраненная сессия
    const savedSession = localStorage.getItem('tg_auth');
    if (savedSession) {
      handleSuccessAuth(JSON.parse(savedSession));
      return;
    }

    // Вариант 3: Нужна новая авторизация
    showAuthButton();
  }

  // 3. Обработка успешной авторизации
  function handleSuccessAuth(user) {
    document.getElementById('username').textContent = user.first_name || 'Пользователь';
    document.getElementById('auth-button').style.display = 'none';
    document.getElementById('user-info').style.display = 'block';
    
    // Сохраняем сессию
    localStorage.setItem('tg_auth', JSON.stringify(user));
    
    // Если в MiniApp - инициализируем WebApp
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }
  }

  // 4. Показываем кнопку авторизации
  function showAuthButton() {
    document.getElementById('auth-button').style.display = 'block';
    document.getElementById('user-info').style.display = 'none';
  }

  // 5. Функция для кнопки "Войти через Telegram"
  function loginWithTelegram() {
    const botId = "7474644739:AAE7YQNPDBmvIdOeKLrrb3j42zjvFL1w4Bs"; // Цифровой ID из @BotFather
    
    // Если внутри MiniApp - используем встроенную авторизацию
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.openTelegramLink(`https://oauth.telegram.org/auth?bot_id=${botId}&origin=${encodeURIComponent(window.location.origin)}&request_access=write`);
      return;
    }
    
    // Для браузера - обычный OAuth
    const authWindow = window.open(
      `https://oauth.telegram.org/auth?bot_id=${botId}&origin=${encodeURIComponent(window.location.origin)}&embed=1&request_access=write`,
      'TelegramAuth',
      'width=500,height=600'
    );

    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://oauth.telegram.org') return;
      
      if (event.data?.event === 'auth_result' && event.data?.result === 'success') {
        handleSuccessAuth(event.data.user);
        if (authWindow) authWindow.close();
      }
    });
  }

  // 6. Выход из системы
  function logout() {
    localStorage.removeItem('tg_auth');
    checkAuth(); // Вернет нас к состоянию авторизации
  }
</script>
</body>
</html>
